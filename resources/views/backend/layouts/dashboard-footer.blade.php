</div>
</div>
</div>
</div>

<!-- Warning Section Starts -->
<!-- Older IE warning message -->
<!--[if lt IE 10]>
<div class="ie-warning">
<h1>Warning!!</h1>
<p>You are using an outdated version of Internet Explorer, please upgrade <br/>to any of the following web browsers to access this website.</p>
<div class="iew-container">
<ul class="iew-download">
<li>
    <a href="http://www.google.com/chrome/">
        <img src="../files/assets/images/browser/chrome.png" alt="Chrome">
        <div>Chrome</div>
    </a>
</li>
<li>
    <a href="https://www.mozilla.org/en-US/firefox/new/">
        <img src="../files/assets/images/browser/firefox.png" alt="Firefox">
        <div>Firefox</div>
    </a>
</li>
<li>
    <a href="http://www.opera.com">
        <img src="../files/assets/images/browser/opera.png" alt="Opera">
        <div>Opera</div>
    </a>
</li>
<li>
    <a href="https://www.apple.com/safari/">
        <img src="../files/assets/images/browser/safari.png" alt="Safari">
        <div>Safari</div>
    </a>
</li>
<li>
    <a href="http://windows.microsoft.com/en-us/internet-explorer/download-ie">
        <img src="../files/assets/images/browser/ie.png" alt="">
        <div>IE (9 & above)</div>
    </a>
</li>
</ul>
</div>
<p>Sorry for the inconvenience!</p>
</div>
<![endif]-->
<!-- Warning Section Ends -->

<script type="text/javascript" src="{{asset('assets/backend')}}\files\bower_components\jquery-ui\js\jquery-ui.min.js"></script>
<script type="text/javascript" src="{{asset('assets/backend')}}\files\bower_components\popper.js\js\popper.min.js"></script>
<script type="text/javascript" src="{{asset('assets/backend')}}\files\bower_components\bootstrap\js\bootstrap.min.js"></script>
<!-- jquery slimscroll js -->
<script type="text/javascript" src="{{asset('assets/backend')}}\files\bower_components\jquery-slimscroll\js\jquery.slimscroll.js"></script>
<!-- modernizr js -->
<script type="text/javascript" src="{{asset('assets/backend')}}\files\bower_components\modernizr\js\modernizr.js"></script>
<script type="text/javascript" src="{{asset('assets/backend')}}\files\bower_components\modernizr\js\css-scrollbars.js"></script>

<!-- Masking js -->
<script src="{{asset('assets/backend')}}\files\assets\pages\form-masking\inputmask.js"></script>
<script src="{{asset('assets/backend')}}\files\assets\pages\form-masking\jquery.inputmask.js"></script>
<script src="{{asset('assets/backend')}}\files\assets\pages\form-masking\autoNumeric.js"></script>
<script src="{{asset('assets/backend')}}\files\assets\pages\form-masking\form-mask.js"></script>
<!-- Gallery js -->
<script src="{{asset('assets/backend')}}\files\bower_components\lightgallery\js\lightgallery.min.js"></script>
<script src="{{asset('assets/backend')}}\files\bower_components\lightgallery\js\lg-fullscreen.min.js"></script>
<script src="{{asset('assets/backend')}}\files\bower_components\lightgallery\js\lg-thumbnail.min.js"></script>
<script src="{{asset('assets/backend')}}\files\bower_components\lightgallery\js\lg-video.min.js"></script>
<script src="{{asset('assets/backend')}}\files\bower_components\lightgallery\js\lg-autoplay.min.js"></script>
<script src="{{asset('assets/backend')}}\files\bower_components\lightgallery\js\lg-zoom.min.js"></script>
<script src="{{asset('assets/backend')}}\files\bower_components\lightgallery\js\lg-hash.min.js"></script>
<script src="{{asset('assets/backend')}}\files\bower_components\lightgallery\js\lg-pager.min.js"></script>

<!-- data-table js -->
<script src="{{asset('assets/backend')}}\files\bower_components\datatables.net\js\jquery.dataTables.min.js"></script>
<script src="{{asset('assets/backend')}}\files\bower_components\datatables.net-buttons\js\dataTables.buttons.min.js"></script>
<script src="{{asset('assets/backend')}}\files\assets\pages\data-table\js\jszip.min.js"></script>
<script src="{{asset('assets/backend')}}\files\assets\pages\data-table\js\pdfmake.min.js"></script>
<script src="{{asset('assets/backend')}}\files\assets\pages\data-table\js\vfs_fonts.js"></script>
<script src="{{asset('assets/backend')}}\files\assets\pages\data-table\extensions\responsive\js\dataTables.responsive.min.js"></script>
<script src="{{asset('assets/backend')}}\files\bower_components\datatables.net-buttons\js\buttons.print.min.js"></script>
<script src="{{asset('assets/backend')}}\files\bower_components\datatables.net-buttons\js\buttons.html5.min.js"></script>
<script src="{{asset('assets/backend')}}\files\bower_components\datatables.net-bs4\js\dataTables.bootstrap4.min.js"></script>
<script src="{{asset('assets/backend')}}\files\bower_components\datatables.net-responsive\js\dataTables.responsive.min.js"></script>
<script src="{{asset('assets/backend')}}\files\bower_components\datatables.net-responsive-bs4\js\responsive.bootstrap4.min.js"></script>
<!-- Bootstrap date-time-picker js -->
<script type="text/javascript" src="{{asset('assets/backend')}}\files\assets\pages\advance-elements\moment-with-locales.min.js"></script>
<script type="text/javascript" src="{{asset('assets/backend')}}\files\bower_components\bootstrap-datepicker\js\bootstrap-datepicker.min.js"></script>
<script type="text/javascript" src="{{asset('assets/backend')}}\files\assets\pages\advance-elements\bootstrap-datetimepicker.min.js"></script>
<!-- Date-range picker js -->
<script type="text/javascript" src="{{asset('assets/backend')}}\files\bower_components\bootstrap-daterangepicker\js\daterangepicker.js"></script>
<!-- Date-dropper js -->
<script type="text/javascript" src="{{asset('assets/backend')}}\files\bower_components\datedropper\js\datedropper.min.js"></script>

{{-- <script src="{{asset('assets/backend')}}\files\assets\pages\ckeditor\ckeditor.js"></script> --}}

<!-- Chart js -->
<script type="text/javascript" src="{{asset('assets/backend')}}\files\bower_components\chart.js\js\Chart.js"></script>

<!-- amchart js -->
<script src="{{asset('assets/backend')}}\files\assets\pages\widget\amchart\amcharts.js"></script>
<script src="{{asset('assets/backend')}}\files\assets\pages\widget\amchart\serial.js"></script>
<script src="{{asset('assets/backend')}}\files\assets\pages\widget\amchart\light.js"></script>
<script src="{{asset('assets/backend')}}\files\assets\js\jquery.mCustomScrollbar.concat.min.js"></script>
<script type="text/javascript" src="{{asset('assets/backend')}}\files\assets\js\SmoothScroll.js"></script>
<script src="{{asset('assets/backend')}}\files\assets\pages\chart\echarts\js\echarts-all.js" type="text/javascript"></script>
<script src="{{asset('assets/backend')}}\files\assets\pages\chat\js\mmc-common.js"></script>
<script src="{{asset('assets/backend')}}\files\assets\pages\chat\js\mmc-chat.js"></script>
<script type="text/javascript" src="{{asset('assets/backend')}}\files\assets\pages\chat\js\chat.js"></script>
<!-- i18next.min.js -->
<script type="text/javascript" src="{{asset('assets/backend')}}\files\bower_components\i18next\js\i18next.min.js"></script>
<script type="text/javascript" src="{{asset('assets/backend')}}\files\bower_components\i18next-xhr-backend\js\i18nextXHRBackend.min.js"></script>
<script type="text/javascript" src="{{asset('assets/backend')}}\files\bower_components\i18next-browser-languagedetector\js\i18nextBrowserLanguageDetector.min.js"></script>
<script type="text/javascript" src="{{asset('assets/backend')}}\files\bower_components\jquery-i18next\js\jquery-i18next.min.js"></script>
<script src="{{asset('assets/backend')}}\files\assets\pages\user-profile.js"></script>
<script src="{{asset('assets/backend')}}\files\assets\js\pcoded.min.js"></script>
<!-- jquery file upload js -->
<script src="{{asset('assets/backend')}}\files\assets\pages\jquery.filer\js\jquery.filer.min.js"></script>
<script src="{{asset('assets/backend')}}\files\assets\pages\filer\custom-filer.js" type="text/javascript"></script>
<script src="{{asset('assets/backend')}}\files\assets\pages\filer\jquery.fileuploads.init.js" type="text/javascript"></script>


<script src="{{asset('assets/backend')}}\files\assets\js\vartical-layout.min.js"></script>
<script type="text/javascript" src="{{asset('assets/backend')}}\files\assets\pages\dashboard\custom-dashboard.js"></script>

<script>
    $(document).ready(function() {
        $('.lightgallery-popup').lightGallery();
    });
</script>

<script type="text/javascript" src="{{asset('assets/backend')}}\files\assets\js\script.min.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-23581568-13"></script>


<div class="toast toast-session @if (session()->has('success')) {{ 'bg-success show' }}  @elseif(session()->has('error')) {{ 'bg-danger show' }} @else {{ 'hide' }} @endif" role="alert" aria-live="assertive" aria-atomic="true" id="toast_main" >
    <i class="fa fa-times close-icon-toast"></i>

    <div class="toast-header">
       
      <strong class="me-auto error-heading">
         @if (session()->has('success')) {{ 'Success' }}
              
        @elseif(session()->has('error')) {{ 'Error' }}
        @else {{ '' }}
        @endif</strong>
      <small>Just Now</small>
      
    </div>
    <div class="toast-body">
        @if (session()->has('success')) {{ session('success') }}
              
        @elseif(session()->has('error')) {{ session('error') }}
          @else {{ '' }}
        @endif
    </div>
</div>

<script>

    // auto hide errors messge box 
 setTimeout(function() {
   $(".alert, .toast-session").hide('blind', {}, 500)
 }, 8000); 
 </script>
    <script>
       $(document).ready(function() {
        $('#first_table').DataTable({
                responsive: true,
                "scrollX": true,
                "columnDefs": [
                    {
                        "targets": "_all", // Apply the text wrapping to all columns
                        "render": function (data, type, row) {
                            if (type === 'display') {
                                return '<div style="white-space: normal;">' + data + '</div>';
                            }
                            return data;
                        }
                    }
                ]
                });
                $('#second_table').DataTable();

                $('#third_table').DataTable();
          });
          

    </script>

<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'UA-23581568-13');
</script>

<script>
 // add sppinner to buttons
    const buttons = document.querySelectorAll('.btn-spinner');

    buttons.forEach(button => {
        button.addEventListener('click', function() {
            const originalText = button.innerHTML;

            // Replace button text with a spinner icon
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            
        });
    });
</script>

<script>
    $(document).ready(function() {
        // Set the body's height to 100% initially
        $('body').css('height', '100%');

        var messagesContainer = $('.messages-content');
        var lastMessage = messagesContainer.children().last();
        
        // Scroll the messages container to the latest message
        messagesContainer.scrollTop(messagesContainer[0].scrollHeight);
        
        // After scrolling, restore the body's height
        $('body').css('height', '');

        // You can also add a small delay before restoring the body's height to ensure smooth scrolling
        setTimeout(function() {
            $('body').css('height', '');
        }, 100);
    });
</script>

<script>
$(document).ready(function() {

    var ticketId = $('#reply-form').data('ticket-id');
    if(!ticketId){
        return false;
    }
    var messagesContainer = $('.messages-content');

    $('#reply-form').submit(function(e) {
        e.preventDefault();

        var replyText = $('#reply-text').val();
        var token = $('meta[name="csrf-token"]').attr('content');
        var url=$(this).attr('action');
        $.ajax({
            url: url,
            type: 'POST',
            data: {
                _token: token,
                _method: 'PATCH',
                message: replyText
            },
            success: function(response) {
                if (response.success) {
                $('#reply-text').val('');
                $('#validation-errors').html('').hide()
                fetchNewMessages(ticketId);
                }
            },
            error: function(xhr) {
                // Handle error
                if (xhr.responseJSON && xhr.responseJSON.errors) {
                    var errorsHtml = '<ul>';
                    $.each(xhr.responseJSON.errors, function(key, value) {
                        errorsHtml += '<li>' + value + '</li>';
                    });
                    errorsHtml += '</ul>';
                    $('#validation-errors').html(errorsHtml).show();
                     $('#reply-text').val('');

                }

            }
        });
    });

    // Function to fetch new messages
    function fetchNewMessages(ticketId) {
        
        $.ajax({
            url: '/tickets/' + ticketId + '/fetch-messages', // will be change on line server
            type: 'GET',
            success: function(response) {
                
                messagesContainer.html(response.messagesView);
                scrollToBottom(); // Scroll messages container to the bottom
            },
            error: function(xhr) {
                // Handle error
            }
        });
        // Fetch new messages again after a delay
        setTimeout(function() {
            fetchNewMessages(ticketId);
        }, 2000); // Polling interval (in milliseconds)
    }

    // Function to scroll the messages container to the bottom
    function scrollToBottom() {
        messagesContainer.scrollTop(messagesContainer[0].scrollHeight);
    }

    // Call fetchNewMessages initially
    fetchNewMessages(ticketId);
});


</script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const deleteLinks = document.querySelectorAll(".delete-link");
    
        deleteLinks.forEach(deleteLink => {
            deleteLink.addEventListener("click", function(event) {
                event.preventDefault();
                if (confirm("Are you sure to delete this image?")) {
                    const deleteUrl = this.getAttribute("href");
    
                    fetch(deleteUrl, {
                        method: 'GET',
                        headers: {
                            'X-CSRF-TOKEN': '{{ csrf_token() }}' // If needed, provide the CSRF token
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Handle the response data if needed, e.g., show a success message
                        alert(data.message); // Display a message based on the response
                        // Reload the page or update the gallery as needed
                        window.location.href = data.redirect;
                    })
                    .catch(error => {
                        // Handle errors if necessary
                        console.error('Error:', error);
                    });
                }
            });
        });
    });


    </script>


                <script>


            $(document).ready(function () {
                // Function to fetch conversations
                function fetchConversations(showLoading = true) {
                    if (showLoading) {
                        let loadingView = '<div class="d-flex justify-content-center align-items-center"> <span class="label label-primary">Loading.. </span> </div>';
                        $('.user-box').html(loadingView);
                    }
                    
                    $.get('{{ route("conversations.index") }}', function (data) {
                        $('.user-box').html(data.conversationsHtml);
                    });
                }

                // Fetch conversations on page load
                fetchConversations(true);

                // Refresh conversations every 2 seconds
                setInterval(function () {
                    fetchConversations(false); // Don't show loading view on subsequent updates
                }, 2000);


                        // Event handler for selecting a user from the dropdown
                    $('select[name="user_id"]').change(function () {
                        var userId = $(this).val();
                        if (userId !== '') {
                            $.get('{{ route("conversations.show", '') }}/' + userId, function (data) {
                                $('#chat_boxes').html(data.messagesHtml); 
                                // updateChatBox(data.conversation.id,true)
                                conversationId=data.conversation.id;
                                
                                updateChatBox(conversationId,true)

                            });
                        } else {
                            // Clear the chat boxes
                            $('#chat_boxes').empty();
                        }
                    });
                });

        </script>
        <script>
            $(document).on('click', '#main-chat #sidebar .user-box .userlist-box', function () {

var dataId = $(this).attr('data-id');
var dataStatus = $(this).data('status');
var dataUserName = $(this).attr('data-username');
var _return = false;

$('#main-chat .chat-box .boxs .chat-single-box').each(function (index) {

    if ($(this).attr('data-id') == dataId) {

        removeBoxCollapseClass(this);
        ActiveChatBox(this);
        _return = true;
    }
});


if (_return) {

    return;
}
if(dataStatus == "online"){

var newBox = `<li class="chat-single-box card-shadow bg-white active" data-id="${dataId}"><div class="had-container"><div class="chat-header p-10 bg-gray"><div class="user-info d-inline-block f-left"><div class="box-live-status bg-success  d-inline-block m-r-10"></div><a href="#">{1}</a></div><div class="box-tools d-inline-block"><a href="#" class="mini"><i class="icofont icofont-minus f-20 m-r-10"></i></a><a class="close" href="#"><i class="icofont icofont-close f-20"></i></a></div></div><div class="chat-body p-10"><div class="message-scrooler"><div class="messages" id="chat_box_${dataId}"></div></div></div><div class="chat-footer b-t-muted">

    <form id="paper-form_${dataId}">
        <div class="input-group write-msg"><input type="text" class="form-control input-value" placeholder="Type a Message" id="message-input_${dataId}"><span class="input-group-btn"><button  id="paper-btn_${dataId}" class="btn btn-primary "  type="button"><i class="icofont icofont-paper-plane"></i></button></span></div>
        </form>
    
    </div></div></li>`;
}
else{

    var newBox = `<li class="chat-single-box card-shadow bg-white active" data-id="${dataId}"><div class="had-container"><div class="chat-header p-10 bg-gray"><div class="user-info d-inline-block f-left"><div class="box-live-status bg-danger  d-inline-block m-r-10"></div><a href="#">{1}</a></div><div class="box-tools d-inline-block"><a href="#" class="mini"><i class="icofont icofont-minus f-20 m-r-10"></i></a><a class="close" href="#"><i class="icofont icofont-close f-20"></i></a></div></div><div class="chat-body p-10"><div class="message-scrooler" ><div class="messages" id="chat_box_${dataId}"></div></div></div><div class="chat-footer b-t-muted">
        <form id="paper-form_${dataId}">
        <div class="input-group write-msg"><input type="text" class="form-control input-value" placeholder="Type a Message" id="message-input_${dataId}"><span class="input-group-btn"><button  id="paper-btn_${dataId}" class="btn btn-primary "  type="button"><i class="icofont icofont-paper-plane"></i></button></span></div>
        </form>
        </div></div></li>`;
}

$('#main-chat .chat-single-box').removeClass('active');
$('#main-chat .chat-box .boxs').append(newBox.format(dataId, dataUserName, dataStatus));


generatePlaceholder();
boxMinimized();

initialTooltip();

// Attach event listener to the send button in the new chat box
$('#paper-btn_' + dataId).on('click', function () {
    var messageInput = $('#message-input_' + dataId);
    var content = messageInput.val();
    // Send the message
    sendMessage(dataId, content);

    // Clear the input field
    messageInput.val('');
});
// Attach event listener to the form in the new chat box
$('#paper-form_' + dataId).on('submit', function (e) {
    e.preventDefault()
    var messageInput = $('#message-input_' + dataId);
    var content = messageInput.val();
    // Send the message
    sendMessage(dataId, content);

    // Clear the input field
    messageInput.val('');
});


// Initial fetching and updating of messages for all open chat boxes
$('#main-chat .chat-single-box').each(function () {
    var conversationId = $(this).attr('data-id');
    updateChatBox(conversationId,true);
});


});

function sendFormMessage(conversationId) {
    var content=$('#message-input_' + conversationId).val();
    if(content !=''){
        sendMessage(conversationId,content);
        $('#message-input_' + conversationId).val('')
    }
}


var conversationMessagesFetched = {};
function updateChatBox(conversationId,scrollToBottom) {

    var messagesContainer = $('#chat_box_' + conversationId);
     // Check if messages for this conversation have already been fetched
     if (!conversationMessagesFetched[conversationId]) {
        // Show loading view if messages haven't been fetched yet
        let loadingView = '<div class="d-flex justify-content-center align-items-center"> <span class="label label-primary">Loading.. </span> </div>';
        messagesContainer.html(loadingView);
    }

    $.ajax({
        type: 'GET',
        url: '{{ route('messages.fetch', ['conversation' => ':conversationId']) }}'.replace(':conversationId', conversationId),
        success: function (response) {

            var messagesHtml = response.messagesHtml;
            var currentScrollPosition = messagesContainer.scrollTop();
            
            messagesContainer.html(messagesHtml);
            
            // Check if the user has scrolled up
            var userScrolledUp = messagesContainer.scrollTop() > currentScrollPosition;

            if (scrollToBottom) {
                // User hasn't scrolled up, so scroll to the bottom
                var newMessage = messagesContainer.children().last()[0];
                newMessage.scrollIntoView({ behavior: 'smooth', block: 'end' });
            } else {
                // User scrolled up, don't scroll to the bottom
            }

             // Mark messages as fetched for this conversation
            conversationMessagesFetched[conversationId] = true;
        }
    });
}

 // Function to send a message
 function sendMessage(conversationId, content) {
   

    $.ajax({
        type: 'POST',
        url: '{{ route('messages.store') }}', // Adjust the route as needed
        data: {
            _token: '{{ csrf_token() }}',
            conversation_id: conversationId,
            content: content
        },
        success: function (data) {
            // Fetch and update messages in the chat box
            updateChatBox(conversationId,true);
        }
    });
}



$(document).ready(function() {
    setTimeout(function() {
        var isUserScrolling = false;

        startMessagePolling();

        function startMessagePolling() {
            setInterval(function() {
                $('.chat-single-box.active').each(function() {
                    var conversationId = $(this).attr('data-id');
                    updateChatBox(conversationId);
                    
                    // Add the scroll listener for the active chat box's message-scroller
                    var messageScroller = $(this).find('.message-scrooler .messages');
                    messageScroller.on('scroll', function() {
                        isUserScrolling = true;
                        setUserInteracting();
                    });
                });
            }, 1000); // Poll every 1 second
        }

        function setUserInteracting() {
            isUserScrolling = true;
            setTimeout(function() {
                isUserScrolling = false;
            }, 3000); // Disable auto-scrolling for 3 seconds after user interaction
        }

    }, 2000); // Wait for 2 seconds after page load
});



   </script>
</body>

</html>
